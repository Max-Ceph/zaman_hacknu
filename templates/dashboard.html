<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Zaman Bank AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/dashboard_style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="container-fluid">
    <a class="navbar-brand" href="https://www.zamanbank.kz" target="_blank" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
        <img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Zaman Bank Logo" style="height: 40px; width: auto;">
        <span style="font-weight: 600; font-size: 20px; color: #2d9a86;"></span>
</a>
        <a href="/logout" class="btn logout-btn">–í—ã–π—Ç–∏</a>
    </div>
</nav>


    <main class="container-fluid mt-4">
        <div class="row g-4">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="col-lg-5 d-flex flex-column gap-4">
                <!-- –°—á–µ—Ç–∞ -->
                <div class="card">
                    <div class="card-header">üíº –ú–æ–∏ –°—á–µ—Ç–∞</div>
                    <div class="card-body" id="accounts-container">
                        <div class="text-center py-3">
                            <div class="spinner-border text-success" role="status"></div>
                        </div>
                    </div>
                </div>

                <!-- –ù–û–í–û–ï: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü</span>
                        <button class="btn btn-sm btn-success" id="generate-demo-btn" style="font-size: 12px;">
                            üé≤ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                    <div class="card-body" id="analytics-container" style="min-height: 350px;">
                        <div class="text-center py-5">
                            <p class="text-muted">üìä –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
                        </div>
                    </div>
                </div>

                <!-- –ù–û–í–û–ï: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—á—Ç—ã -->
                <div class="card">
                    <div class="card-header">
                        ‚ú® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞—à–µ–π –º–µ—á—Ç—ã
                        <small class="text-muted float-end" style="font-size: 12px;">
                            üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–µ–ª—å –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ—ë
                        </small>
                    </div>
                    <div class="card-body" id="dream-visualization">
                        <div class="text-center py-3">
                            <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ —Ü–µ–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é</p>
                        </div>
                    </div>
                </div>

                <!-- –¶–µ–ª–∏ -->
                <div class="card">
                    <div class="card-header">
                        üéØ –ú–æ–∏ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¶–µ–ª–∏
                        <small class="text-muted float-end" style="font-size: 11px;">
                            üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–µ–ª—å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                        </small>
                    </div>
                    <div class="card-body" id="goals-container">
                        <div class="text-center py-3">
                            <div class="spinner-border text-success" role="status"></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <form id="add-goal-form">
                            <div class="mb-2">
                                <select id="goal-type" class="form-select mb-2">
                                    <option value="house">üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                                    <option value="car">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                                    <option value="travel">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</option>
                                    <option value="education">üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                                    <option value="business">üíº –ë–∏–∑–Ω–µ—Å</option>
                                    <option value="other">üéÅ –î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="text" id="goal-name" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏" required>
                            </div>
                            <div class="mb-3">
                                <input type="number" id="target-amount" class="form-control" placeholder="–°—É–º–º–∞, KZT" required min="1">
                            </div>
                            <button type="submit" class="btn btn-zaman w-100">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¶–µ–ª—å</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
            <div class="col-lg-7">
                <div class="card chat-card">
                    <div class="card-header">üí¨ –í–∞—à AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç - –ê–º–∏—Ä</div>
                    <div class="card-body p-0">
                        <div id="chat-box">
                            <div class="chat-message bot-message">
                                <strong>–ê–º–∏—Ä:</strong> –ê—Å—Å–∞–ª–∞–º–∞“ì–∞–ª–µ–π–∫“±–º, {{ username }}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?
                            </div>
                        </div>
                    </div>
                    <div class="card-footer chat-input-area">
                        <div class="position-relative">
                            <div id="recording-indicator" style="display: none;">‚óè –ó–∞–ø–∏—Å—å...</div>
                            <div class="input-group">
                                <input type="text" id="user-message" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." autocomplete="off">
                                <button class="btn" id="record-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üéôÔ∏è</button>
                                <button class="btn btn-zaman" id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            loadAccounts();
            loadGoals();
            loadAnalytics();

            // === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
            function loadAccounts() {
                $.ajax({
                    url: "/api/accounts",
                    type: "GET",
                    success: function(accounts) {
                        const container = $("#accounts-container");
                        container.empty();
                        if (accounts.length === 0) {
                            container.html('<p class="text-center text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—á–µ—Ç–æ–≤.</p>');
                        } else {
                            accounts.forEach(function(acc) {
                                const balance = parseFloat(acc.balance.$numberDecimal);
                                const accountHtml = `
                                    <div class="account-item">
                                        <h5>${acc.accountName}</h5>
                                        <div class="account-balance">${balance.toLocaleString('ru-RU')} ${acc.currency}</div>
                                    </div>`;
                                container.append(accountHtml);
                            });
                        }
                    }
                });
            }

            let selectedGoalId = null; // –•—Ä–∞–Ω–∏–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏

            function loadGoals() {
                $.ajax({
                    url: "/api/goals",
                    type: "GET",
                    success: function(goals) {
                        const container = $("#goals-container");
                        container.empty();
                        if (goals.length === 0) {
                            container.html('<p class="text-center text-muted">–£ –≤–∞—Å –Ω–µ—Ç —Ü–µ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>');
                            $("#dream-visualization").html('<p class="text-center text-muted">–°–æ–∑–¥–∞–π—Ç–µ —Ü–µ–ª—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é</p>');
                        } else {
                            goals.forEach(function(goal, index) {
                                const current = parseFloat(goal.currentAmount.$numberDecimal);
                                const target = parseFloat(goal.targetAmount.$numberDecimal);
                                const percentage = target > 0 ? (current / target) * 100 : 0;
                                const goalId = goal._id.$oid;

                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —ç—Ç–∞ —Ü–µ–ª—å
                                const isSelected = selectedGoalId === goalId || (selectedGoalId === null && index === 0);
                                const selectedClass = isSelected ? 'goal-selected' : '';

                                const goalHtml = `
                                    <div class="goal-item ${selectedClass}" data-goal-id="${goalId}" style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><strong>${goal.goalName}</strong></span>
                                            <span class="text-muted">${percentage.toFixed(0)}%</span>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar" style="width: ${Math.min(percentage, 100)}%"></div>
                                        </div>
                                        <small class="text-muted">${current.toLocaleString('ru-RU')} / ${target.toLocaleString('ru-RU')} KZT</small>
                                    </div>`;
                                container.append(goalHtml);
                            });

                            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ü–µ–ª–∏
                            $('.goal-item').on('click', function() {
                                const clickedGoalId = $(this).data('goal-id');
                                selectedGoalId = clickedGoalId;

                                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–µ–ª–µ–π
                                $('.goal-item').removeClass('goal-selected');
                                // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é
                                $(this).addClass('goal-selected');

                                // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å
                                const selectedGoal = goals.find(g => g._id.$oid === clickedGoalId);
                                if (selectedGoal) {
                                    visualizeDream(selectedGoal);
                                }
                            });

                            // –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Ü–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—É—é
                            const goalToVisualize = selectedGoalId
                                ? goals.find(g => g._id.$oid === selectedGoalId)
                                : goals[0];

                            if (goalToVisualize) {
                                visualizeDream(goalToVisualize);
                                if (!selectedGoalId) {
                                    selectedGoalId = goalToVisualize._id.$oid;
                                }
                            }
                        }
                    }
                });
            }

            // === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—á—Ç—ã ===
            function visualizeDream(goal) {
                if (!goal) return;

                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é fade-out
                $("#dream-visualization").fadeOut(200, function() {
                    const current = parseFloat(goal.currentAmount.$numberDecimal);
                    const target = parseFloat(goal.targetAmount.$numberDecimal);
                    const percentage = (current / target) * 100;
                    const remaining = target - current;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —Ç–∏–ø—É —Ü–µ–ª–∏
                    const dreamImages = {
                        'house': {emoji: 'üè†', desc: '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∂–∏–ª—å–µ', color: '#4CAF50'},
                        'car': {emoji: 'üöó', desc: '–ê–≤—Ç–æ–º–æ–±–∏–ª—å –º–µ—á—Ç—ã', color: '#2196F3'},
                        'travel': {emoji: '‚úàÔ∏è', desc: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', color: '#FF9800'},
                        'education': {emoji: 'üéì', desc: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', color: '#9C27B0'},
                        'business': {emoji: 'üíº', desc: '–°–≤–æ–π –±–∏–∑–Ω–µ—Å', color: '#F44336'},
                        'other': {emoji: 'üéÅ', desc: '–ú–µ—á—Ç–∞', color: '#00BCD4'}
                    };

                    const dreamType = goal.goalType || 'other';
                    const dream = dreamImages[dreamType] || dreamImages['other'];

                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫ –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è—Ö (–ø—Ä–∏–º–µ—Ä–Ω–æ)
                    const monthlyContribution = 50000; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                    const monthsToGoal = Math.ceil(remaining / monthlyContribution);

                    const visualizationHtml = `
                        <div class="text-center">
                            <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 2s infinite;">${dream.emoji}</div>
                            <h4 style="color: ${dream.color};">${goal.goalName}</h4>
                            <p class="text-muted">${dream.desc}</p>

                            <div class="mt-4">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="p-3 bg-light rounded">
                                            <h5 style="color: ${dream.color};">${percentage.toFixed(0)}%</h5>
                                            <small class="text-muted">–ì–æ—Ç–æ–≤–æ</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 bg-light rounded">
                                            <h5 style="color: ${dream.color};">${remaining.toLocaleString('ru-RU')}‚Ç∏</h5>
                                            <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 bg-light rounded">
                                            <h5 style="color: ${dream.color};">~${monthsToGoal} –º–µ—Å</h5>
                                            <small class="text-muted">–î–æ —Ü–µ–ª–∏</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="timeline">
                                    <div class="timeline-item ${percentage >= 25 ? 'completed' : ''}">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-label">–°—Ç–∞—Ä—Ç</div>
                                    </div>
                                    <div class="timeline-line ${percentage >= 25 ? 'completed' : ''}"></div>
                                    <div class="timeline-item ${percentage >= 50 ? 'completed' : ''}">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-label">25%</div>
                                    </div>
                                    <div class="timeline-line ${percentage >= 50 ? 'completed' : ''}"></div>
                                    <div class="timeline-item ${percentage >= 75 ? 'completed' : ''}">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-label">50%</div>
                                    </div>
                                    <div class="timeline-line ${percentage >= 75 ? 'completed' : ''}"></div>
                                    <div class="timeline-item ${percentage >= 100 ? 'completed' : ''}">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-label">–¶–µ–ª—å!</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    $(this).html(visualizationHtml).fadeIn(400);
                });
            }

            // === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ===
            function loadAnalytics() {
                console.log('üìä –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');

                $.ajax({
                    url: "/api/analytics",
                    type: "GET",
                    success: function(data) {
                        console.log("‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:", data);

                        if (data && data.analysis) {
                            displayAnalytics(data);
                        } else {
                            console.error("‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);
                            $("#analytics-container").html(`
                                <div class="alert alert-warning">
                                    <strong>–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</strong><br>
                                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ —Å–Ω–æ–≤–∞
                                </div>
                            `);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏");
                        console.error("–°—Ç–∞—Ç—É—Å:", xhr.status);
                        console.error("–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:", error);
                        console.error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", xhr.responseText);

                        if (xhr.status === 400) {
                            $("#analytics-container").html(`
                                <div class="text-center py-3">
                                    <p class="text-muted">üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
                                    <p class="text-muted" style="font-size: 13px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>
                                </div>
                            `);
                        } else {
                            $("#analytics-container").html(`
                                <div class="alert alert-warning">
                                    <strong>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</strong><br>
                                    –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üé≤ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ" –≤—ã—à–µ
                                </div>
                            `);
                        }
                    }
                });
            }

            function displayAnalytics(data) {
                const categories = data.analysis.categories;
                const recommendations = data.recommendations;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
                if (!categories || Object.keys(categories).length === 0) {
                    $("#analytics-container").html(`
                        <div class="alert alert-warning">
                            <strong>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö</strong><br>
                            –ù–∞–∂–º–∏—Ç–µ "üé≤ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                        </div>
                    `);
                    return;
                }

                let html = `
                    <div class="mb-3">
                        <h6>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: <strong style="color: #00c853;">${data.analysis.total_expenses.toLocaleString('ru-RU')}‚Ç∏</strong></h6>
                    </div>
                    <div style="position: relative; height: 250px; margin-bottom: 20px;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                `;

                if (recommendations) {
                    html += `
                        <div class="alert alert-info mt-3" style="font-size: 14px; line-height: 1.6;">
                            ${recommendations.replace(/\n\n/g, '<br><br>')}
                        </div>
                    `;
                }

                $("#analytics-container").html(html);

                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (window.expenseChartInstance) {
                    window.expenseChartInstance.destroy();
                }

                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                const ctx = document.getElementById('expenseChart').getContext('2d');
                window.expenseChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: [
                                '#4CAF50', '#2196F3', '#FF9800', '#9C27B0',
                                '#F44336', '#00BCD4', '#FFC107', '#795548'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value.toLocaleString('ru-RU')}‚Ç∏ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ï–ú–û-–î–ê–ù–ù–´–• ===
            $("#generate-demo-btn").on("click", function() {
                const btn = $(this);
                btn.prop('disabled', true).html('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');

                $.ajax({
                    url: "/api/generate-demo-data",
                    type: "POST",
                    success: function(response) {
                        console.log('‚úÖ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', response);
                        showNotification('‚úÖ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');

                        // –í–ê–ñ–ù–û: –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                        setTimeout(function() {
                            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É...');
                            loadAnalytics();
                        }, 800);
                    },
                    error: function(xhr, status, error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö:', error);
                        console.error('–°—Ç–∞—Ç—É—Å:', xhr.status);
                        console.error('–û—Ç–≤–µ—Ç:', xhr.responseText);
                        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (xhr.responseJSON?.error || error), 'danger');
                    },
                    complete: function() {
                        btn.prop('disabled', false).html('üé≤ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
                    }
                });
            });

            // === –î–û–ë–ê–í–õ–ï–ù–ò–ï –¶–ï–õ–ò (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å —Ç–∏–ø–æ–º) ===
            $("#add-goal-form").on("submit", function(e) {
                e.preventDefault();
                const goalType = $("#goal-type").val();
                const goalName = $("#goal-name").val().trim();
                const targetAmount = $("#target-amount").val();

                if (!goalName || !targetAmount) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                    return;
                }

                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true).html('‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...');

                $.ajax({
                    url: "/api/goals",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        goalType: goalType,
                        goalName: goalName,
                        targetAmount: parseFloat(targetAmount)
                    }),
                    success: function() {
                        $("#goal-name").val('');
                        $("#target-amount").val('');
                        loadGoals();
                        showNotification('–¶–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                        showNotification('–û—à–∏–±–∫–∞: ' + errorMsg, 'danger');
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html('‚ûï –î–æ–±–∞–≤–∏—Ç—å –¶–µ–ª—å');
                    }
                });
            });

            // === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
            function showNotification(message, type = 'success') {
                const notification = $(`
                    <div class="alert alert-${type} alert-dismissible fade show position-fixed"
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;"
                         role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                $('body').append(notification);
                setTimeout(() => notification.alert('close'), 3000);
            }

            // === –ß–ê–¢ ===
            $("#send-button").on("click", function() {
                const message = $("#user-message").val().trim();
                if (message !== "") {
                    sendMessage(message);
                }
            });

            $("#user-message").on("keypress", function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $("#send-button").click();
                }
            });

            function sendMessage(message) {
                const chatBox = $("#chat-box");
                const userHtml = `<div class="chat-message user-message">${escapeHtml(message)}</div>`;
                chatBox.append(userHtml);
                $("#user-message").val("");
                chatBox.scrollTop(chatBox[0].scrollHeight);

                const typingIndicator = $('<div class="chat-message bot-message" id="typing"><strong>–ê–º–∏—Ä:</strong> <em>–ø–µ—á–∞—Ç–∞–µ—Ç...</em></div>');
                chatBox.append(typingIndicator);
                chatBox.scrollTop(chatBox[0].scrollHeight);

                $.ajax({
                    url: "/chat",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ message: message }),
                    success: function(data) {
                        $("#typing").remove();

                        let botReply = escapeHtml(data.reply);

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –±–∞–Ω–∫–∞
                        if (data.open_bank_site === true && data.bank_url) {
                            console.log("‚úÖ –î–æ–±–∞–≤–ª—è—é —Å—Å—ã–ª–∫—É –Ω–∞ –±–∞–Ω–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ");
                            botReply += ` <a href="${data.bank_url}" target="_blank" style="color: #00c853; font-weight: 600; text-decoration: underline;">‚Üí –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç Zaman Bank</a>`;
                        }

                        const botHtml = `<div class="chat-message bot-message"><strong>–ê–º–∏—Ä:</strong> ${botReply}</div>`;
                        chatBox.append(botHtml);
                        chatBox.scrollTop(chatBox[0].scrollHeight);

                        // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å popup
                        if (data.open_bank_site === true && data.bank_url) {
                            setTimeout(() => {
                                const newWindow = window.open(data.bank_url, '_blank');
                                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                                    showNotification('‚ÑπÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –±–∞–Ω–∫–∞', 'info');
                                }
                            }, 1000);
                        }
                    },
                    error: function() {
                        $("#typing").remove();
                        const errorHtml = `<div class="chat-message bot-message"><strong>–ê–º–∏—Ä:</strong> <em style="color: #dc3545;">–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</em></div>`;
                        chatBox.append(errorHtml);
                        chatBox.scrollTop(chatBox[0].scrollHeight);
                    }
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // === –ì–û–õ–û–°–û–í–û–ô –í–í–û–î ===
            const recordBtn = $("#record-btn");
            const recordingIndicator = $("#recording-indicator");
            let isRecording = false;
            let mediaRecorder;
            let audioChunks = [];

            recordBtn.on('click', async function() {
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                        mediaRecorder.onstop = sendAudioToServer;
                        mediaRecorder.start();
                        isRecording = true;
                        recordBtn.html('‚èπÔ∏è').css('background', '#dc3545');
                        recordingIndicator.show();
                    } catch (error) {
                        showNotification("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω", "warning");
                    }
                } else {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.html('üéôÔ∏è').css('background', '');
                    recordingIndicator.text('‚óè –û–±—Ä–∞–±–æ—Ç–∫–∞...').show();
                }
            });

            function sendAudioToServer() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioChunks = [];
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                fetch('/transcribe', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.transcribed_text) {
                            $("#user-message").val(data.transcribed_text);
                            sendMessage(data.transcribed_text);
                        } else if (data.error) {
                            showNotification("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: " + data.error, "danger");
                        }
                    })
                    .catch(error => {
                        showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å", "danger");
                    })
                    .finally(() => recordingIndicator.hide());
            }
        });
    </script>

    <style>
        /* –ù–û–í–û–ï: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —á–∞—Ç –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É */
        .chat-card {
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .chat-card .card-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            scroll-behavior: smooth;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —á–∞—Ç–∞ */
        #chat-box::-webkit-scrollbar {
            width: 8px;
        }

        #chat-box::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #chat-box::-webkit-scrollbar-thumb {
            background: #00c853;
            border-radius: 10px;
        }

        #chat-box::-webkit-scrollbar-thumb:hover {
            background: #00a844;
        }

        .chat-input-area {
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 15px;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, #2d9a86 0%, #5eccb8 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .bot-message strong {
            color: #2d9a86;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è timeline –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .timeline-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ddd;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .timeline-item.completed .timeline-dot {
            background: #00c853;
            box-shadow: 0 0 20px rgba(0,200,83,0.5);
        }

        .timeline-line {
            flex: 1;
            height: 3px;
            background: #ddd;
            margin: 0 -5px;
            transition: all 0.3s ease;
        }

        .timeline-line.completed {
            background: linear-gradient(90deg, #2d9a86, #00e676);
        }

        .timeline-label {
            margin-top: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .timeline-item.completed .timeline-label {
            color: #2d9a86;
        }

        /* –ù–û–í–´–ï –°–¢–ò–õ–ò: –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ */
        .goal-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .goal-item:hover {
            background: #e9ecef;
            border-color: #2d9a86;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 200, 83, 0.15);
        }

        .goal-item.goal-selected {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%);
            border: 2px solid #2d9a86;
            box-shadow: 0 4px 16px rgba(0, 200, 83, 0.25);
        }

        .goal-item.goal-selected::before {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #2d9a86;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0, 200, 83, 0.4);
        }

        .goal-item.goal-selected .progress-bar {
            background: linear-gradient(90deg, #2d9a86, #00e676);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–∫–∏ –º–µ—á—Ç—ã */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ */
        #dream-visualization {
            transition: opacity 0.4s ease;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í */
        @media (max-width: 991px) {
            .chat-card {
                height: 600px;
                margin-top: 20px;
            }
        }

        @media (max-width: 576px) {
            .chat-card {
                height: 500px;
            }

            #chat-box {
                padding: 15px;
            }

            .chat-message {
                max-width: 90%;
                padding: 10px 14px;
                font-size: 14px;
            }
        }
    </style>
</body>
</html>